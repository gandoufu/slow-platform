# FastAPI接口自动化测试平台 - 后端返回数据结构规划

## 1. 通用响应结构设计

### 基础响应包装器
```python
from typing import TypeVar, Generic, Optional, Any
from pydantic import BaseModel
from datetime import datetime

T = TypeVar('T')

class ApiResponse(BaseModel, Generic[T]):
    """统一API响应格式"""
    code: int = 200  # 状态码
    message: str = "success"  # 提示信息
    data: Optional[T] = None  # 响应数据
    timestamp: datetime = datetime.now()  # 时间戳
```

### 分页响应结构
```python
class PaginatedResponse(BaseModel, Generic[T]):
    """分页数据响应"""
    items: list[T]  # 当前页数据
    total: int  # 总记录数
    page: int  # 当前页码
    page_size: int  # 每页大小
    total_pages: int  # 总页数
    has_next: bool  # 是否有下一页
    has_prev: bool  # 是否有上一页
```

## 2. 标准化错误处理

### 错误码定义
```python
from enum import IntEnum

class ErrorCode(IntEnum):
    """错误码枚举"""
    SUCCESS = 200
    BAD_REQUEST = 400
    UNAUTHORIZED = 401
    FORBIDDEN = 403
    NOT_FOUND = 404
    INTERNAL_ERROR = 500
    VALIDATION_ERROR = 422
    
    # 业务相关错误码
    TEST_EXECUTION_FAILED = 1001
    TEST_CASE_NOT_FOUND = 1002
    PROJECT_NOT_FOUND = 1003
    ENVIRONMENT_NOT_FOUND = 1004
```

### 错误响应结构
```python
class ErrorResponse(BaseModel):
    """错误响应"""
    code: int
    message: str
    details: Optional[dict] = None  # 错误详情
    timestamp: datetime = datetime.now()
    path: Optional[str] = None  # 请求路径
```

## 3. 使用示例

### FastAPI路由响应示例
```python
from fastapi import FastAPI, HTTPException
from typing import List

app = FastAPI()

@app.get("/projects/{project_id}", response_model=ApiResponse[ProjectResponse])
async def get_project(project_id: int):
    try:
        project = await get_project_from_db(project_id)
        return ApiResponse(data=project)
    except ProjectNotFoundError as e:
        return ApiResponse(
            code=ErrorCode.NOT_FOUND,
            message=str(e),
            data=None
        )

@app.get("/projects", response_model=ApiResponse[PaginatedResponse[ProjectResponse]])
async def list_projects(page: int = 1, page_size: int = 20):
    projects, total = await get_projects_with_pagination(page, page_size)
    paginated_data = PaginatedResponse(
        items=projects,
        total=total,
        page=page,
        page_size=page_size,
        total_pages=(total + page_size - 1) // page_size,
        has_next=page * page_size < total,
        has_prev=page > 1
    )
    return ApiResponse(data=paginated_data)

@app.post("/test-executions", response_model=ApiResponse[TestExecutionResponse])
async def execute_tests(request: TestExecutionRequest):
    execution_id = await start_test_execution(request)
    return ApiResponse(
        data=TestExecutionResponse(
            execution_id=execution_id,
            status="pending",
            total_tests=len(request.test_case_ids),
            started_at=datetime.now()
        )
    )
```

### 全局异常处理
```python
from fastapi.responses import JSONResponse
from fastapi import Request
from fastapi.exceptions import RequestValidationError

@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=400,
        content=ApiResponse(
            code=ErrorCode.VALIDATION_ERROR,
            message="请求参数验证失败",
            data={"errors": exc.errors()}
        ).dict()
    )

@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    return JSONResponse(
        status_code=exc.status_code,
        content=ApiResponse(
            code=exc.status_code,
            message=exc.detail,
            data=None
        ).dict()
    )
```
