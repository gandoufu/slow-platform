**一、文档信息**

- 文档名称：接口自动化测试平台 系统架构设计文档  
- 产品名称：Slow Platform / 接口自动化测试平台  
- 版本：V1.0（对应 PRD V1 核心功能）  
- 编写人：neway  
- 审核人：neway
- 创建日期：2026-02-10

---

**二、总体设计**

- 设计目标：  
  - 支撑 PRD 中 V1 核心功能：  
    - 项目与环境管理  
    - 接口管理（手工维护）  
    - 单接口测试用例  
    - 场景/多接口组合测试（含变量传递与基础断言）  
    - 测试计划与执行管理  
    - 执行结果与基础报告查看  
    - 简单登录与基础角色区分  
  - 满足：简单易用、结构清晰，便于后续扩展数据驱动、CI/CD、Mock 等能力。

- 技术栈选型：  
  - 前端：React（建议配合 TypeScript、UI 组件库如 Ant Design）  
  - 后端：FastAPI（Python 3.x）  
  - 数据库：MySQL（InnoDB）  
  - ORM & 迁移：SQLAlchemy + Alembic  
  - HTTP 调用执行引擎：Python `requests` 库  
  - 鉴权：基于 JWT 的 Token 认证（或后续接入公司统一认证）

- 整体架构风格：  
  - 典型 **前后端分离** + **单体后端服务** 架构：  
    - 前端静态资源通过 Nginx 或后端服务静态托管。  
    - 后端提供 RESTful API，统一进行业务处理与测试执行。  
    - 数据存储集中在 MySQL。

---

**三、系统架构与模块划分**

**3.1 高层架构**

- 表现层（Web 前端）  
  - React 应用，通过浏览器访问。  
  - 与后端通过 HTTPS + JSON API 通信。  

- 应用层 / 接口层（FastAPI 路由）  
  - 对外暴露 REST API：用户/登录、项目、环境、接口、用例、场景、计划、执行、配置等。  
  - 做参数校验、简单鉴权校验，将请求委托给业务服务层。

- 业务服务层（Service）  
  - 实现 PRD 中各功能模块的业务逻辑：  
    - 用户与权限服务  
    - 项目与环境服务  
    - 接口与用例服务  
    - 场景与步骤服务  
    - 测试计划服务  
    - 执行引擎服务  
    - 报告与查询服务  
    - 配置与变量服务  

- 基础设施层（Infra）  
  - 数据访问（Repository）：对接 MySQL（SQLAlchemy）。  
  - HTTP Client：封装 `requests` 用于实际调用被测接口。  
  - 日志、配置管理、缓存（如后续可添加 Redis）等。

**3.2 功能模块划分（与 PRD 对齐）**

- 用户与权限模块  
- 项目管理模块  
- 环境管理模块  
- 接口管理模块  
- 单接口用例管理模块  
- 场景用例管理模块  
- 测试计划与执行管理模块  
- 执行结果与报告模块  
- 变量与配置模块

模块之间的依赖关系（简化说明）：

- 用户与权限模块：其他模块调用其鉴权/鉴权接口。  
- 项目模块：作为环境、接口、用例、场景、计划等资源的“顶层归属”。  
- 环境模块：提供执行时的 Base URL、公共 Header 等信息。  
- 接口模块：为单接口用例和场景步骤提供基础请求模版。  
- 用例模块：基于接口形成可直接执行的单接口测试单元。  
- 场景模块：编排多个步骤（步骤关联接口或用例），利用变量完成数据流转。  
- 测试计划模块：组织多个场景，统一执行和查看结果。  
- 执行结果模块：与用例、场景、计划模块配合，呈现执行历史与详情。  
- 变量与配置模块：被接口、用例、场景共享，用于变量替换与配置管理。

---

**四、数据库设计概要（概要级，详细见数据库设计文档）**

这里只做核心表结构概览，为后端与业务逻辑设计提供支撑。真正落地可以在数据库设计文档中细化字段、索引等。

**4.1 用户与权限相关**

- `user`  
  - id  
  - username  
  - password_hash  
  - display_name  
  - role（枚举：ADMIN / TESTER）  
  - is_active  
  - created_at / updated_at  

- 如后续需要细化权限，可扩展 `role`、`permission`、`user_role` 等关联表。

**4.2 项目与环境**

- `project`  
  - id  
  - name  
  - description  
  - owner_id（关联 user）  
  - is_active  
  - created_at / updated_at  

- `environment`  
  - id  
  - project_id  
  - name（如 dev、test）  
  - base_url  
  - default_flag  
  - description  
  - created_at / updated_at  

- `environment_header`（可选，如果公共头需要结构化存）  
  - id  
  - environment_id  
  - key  
  - value  

**4.3 接口与单接口用例**

- `api`（接口定义）  
  - id  
  - project_id  
  - module_name / group（模块或分组）  
  - name  
  - method（GET/POST/PUT/DELETE/PATCH）  
  - url_path（支持路径变量）  
  - description  
  - created_at / updated_at  

- `api_request_template`（接口默认请求配置）  
  - id  
  - api_id  
  - path_params（JSON）  
  - query_params（JSON）  
  - headers（JSON）  
  - body（JSON / TEXT，配合类型字段）  
  - body_type（JSON / FORM / X_WWW_FORM_URLENCODED / RAW）  

- `api_test_case`（单接口用例）  
  - id  
  - project_id  
  - api_id  
  - name  
  - precondition_text  
  - request_override（JSON：覆盖默认请求的字段）  
  - tags（字符串或 JSON 数组）  
  - is_active  
  - created_at / updated_at  

- `api_test_case_assert`（单接口用例断言）  
  - id  
  - case_id  
  - assert_type（STATUS_CODE / JSON_FIELD / DURATION 等）  
  - expression（如 JSONPath 或字段路径）  
  - operator（=、!=、>、<、CONTAINS 等）  
  - expected_value（字符串存储，具体类型由前端/后端转换）  

**4.4 场景与步骤**

- `scene`  
  - id  
  - project_id  
  - name  
  - module_name（可选）  
  - description  
  - tags  
  - is_active  
  - created_at / updated_at  

- `scene_step`  
  - id  
  - scene_id  
  - order_index  
  - step_name  
  - ref_type（API / CASE）  —— 是直接基于接口还是基于单接口用例  
  - ref_id（api_id 或 case_id）  
  - request_override（JSON：在该步骤上对接口/用例请求的覆盖）  
  - enabled_flag  

- `scene_step_extract`（变量抽取配置）  
  - id  
  - step_id  
  - variable_name（如 token）  
  - source_type（RESPONSE_JSON / RESPONSE_HEADER 等）  
  - expression（JSONPath / Header key）  

- `scene_step_assert`  
  - id  
  - step_id  
  - assert_type  
  - expression  
  - operator  
  - expected_value  

**4.5 测试计划与执行记录**

- `test_plan`  
  - id  
  - project_id  
  - name  
  - description  
  - is_active  
  - created_at / updated_at  

- `test_plan_scene`（计划包含的场景）  
  - id  
  - plan_id  
  - scene_id  
  - order_index  

- `execution`（统一的执行记录表，既可记录计划执行，也可记录单场景/单用例执行）  
  - id  
  - project_id  
  - target_type（CASE / SCENE / PLAN）  
  - target_id（对应 case_id / scene_id / plan_id）  
  - environment_id  
  - trigger_type（MANUAL / FUTURE: CI 等）  
  - status（RUNNING / SUCCESS / FAILED / PARTIAL_FAILED / ERROR）  
  - total_count / success_count / failed_count（对场景/计划统计）  
  - started_at / finished_at  
  - triggered_by（user_id）  

- `execution_step`（执行步骤记录，主要用于场景 / 计划场景）  
  - id  
  - execution_id  
  - scene_id（可选）  
  - scene_step_id（可选）  
  - case_id / api_id  
  - order_index  
  - status（SUCCESS/FAILED/ERROR/SKIPPED）  
  - request_snapshot（JSON：最终请求，包括 URL、headers、body）  
  - response_snapshot（JSON：status_code、headers、body、duration）  
  - asserts_result（JSON：断言逐条结果）  
  - error_message  

**4.6 变量与配置**

- `variable`（项目级变量，可细分类型）  
  - id  
  - project_id  
  - scope（GLOBAL / ENV / SCENE）  
  - environment_id（当 scope=ENV 时有值）  
  - scene_id（当 scope=SCENE 时有值）  
  - name  
  - value  
  - description  

- `system_config`（平台配置）  
  - id  
  - key  
  - value  
  - description  

---

**五、后端设计（FastAPI）**

**5.1 应用分层结构建议**

目录结构（示意）：

```bash
app/
  main.py                # 入口
  core/                  # 核心配置、日志、中间件
  api/                   # 路由层
    v1/
      routers/
        auth.py
        projects.py
        envs.py
        apis.py
        cases.py
        scenes.py
        plans.py
        executions.py
        variables.py
  models/                # SQLAlchemy ORM 模型（表）
  schemas/               # Pydantic 模型（请求/响应）
  services/              # 业务服务层
  repositories/          # 数据访问层
  execution/             # 执行引擎（HTTP 请求、变量替换、断言）
  utils/                 # 通用工具
```

- `api/routers`：  
  - 每个模块一个 router，统一前缀，如 `/api/v1/projects`。  
  - 完成请求参数解析、鉴权（依赖注入）、调用 service。  

- `services`：  
  - 模块级服务，例如 `ProjectService`、`EnvService`、`ApiService`、`CaseService`、`SceneService`、`PlanService`、`ExecutionService`、`VariableService`。  
  - 封装业务逻辑，例如创建场景时检查所属项目是否存在等。  

- `repositories`：  
  - 负责操作 ORM 模型，与数据库交互。  
  - 提供 CRUD 接口，如 `get_by_id`、`list_by_project`、`create`、`update`、`delete`。  

- `execution`：  
  - 核心的 **执行引擎**：负责真正调用被测接口、变量替换、断言执行、记录结果。

**5.2 鉴权与安全**

- 登录：  
  - `/api/v1/auth/login` 接收用户名密码，验证成功后返回 JWT。  
  - 前端存储 Token（建议使用 HttpOnly Cookie 或 LocalStorage，视安全要求），后续请求附带 Authorization Header。  

- 鉴权：  
  - FastAPI 依赖注入方式解析 Token，获取当前用户信息。  
  - 简单角色控制：  
    - ADMIN：可管理用户、系统配置等（V1 界面可弱化）。  
    - TESTER：可访问项目、接口、用例、场景等功能。  

**5.3 执行引擎设计（重点）**

- 目标：  
  - 支持单接口用例执行、场景执行、计划执行。  
  - 支持变量替换、变量抽取、断言执行。  
  - 量级不大，可采用 **同步执行**（在 HTTP 请求生命周期内完成）。  

- 核心流程（以场景执行为例）：  
  1. `ExecutionService.start_scene_execution(scene_id, environment_id, user_id)`  
  2. 创建 `execution` 记录（target_type=SCENE，status=RUNNING）。  
  3. 加载场景、步骤、场景级变量配置。  
  4. 初始化变量上下文：  
     - 注入环境变量（BASE_URL 等）  
     - 注入项目全局变量  
     - 注入执行时用户传入的临时变量（如未来可扩展）。  
  5. 按 `order_index` 遍历启用的 `scene_step`：  
     - 解析引用的接口/用例，合并默认请求 + 步骤覆盖。  
     - 对 URL、Header、Query、Body 做变量替换（`{{var_name}}`）。  
     - 调用 HTTP Client 发送请求（封装 `requests`），捕获响应与耗时。  
     - 执行步骤断言（场景步骤级 + 用例级）：  
       - 状态码断言  
       - 响应时间断言  
       - JSON 字段断言（通过 JSONPath 解析）  
     - 执行抽取规则，将响应中的字段写入变量上下文（场景变量）。  
     - 生成 `execution_step` 记录，包含：  
       - 实际请求快照  
       - 响应快照  
       - 断言结果  
       - 状态（SUCCESS / FAILED / ERROR）  
     - 如配置为“失败继续”（V1 默认可以这样）：在断言失败时继续下一个步骤，只标记步骤状态与错误信息。  
  6. 全部步骤完成后，根据步骤结果更新 `execution.status`：  
     - 若全部成功：SUCCESS  
     - 若有失败：FAILED / PARTIAL_FAILED  
  7. 返回执行汇总信息给前端。  

- 单接口用例、测试计划执行流程类似：  
  - 单接口用例：只有一个步骤，直接走上述流程子集。  
  - 测试计划：遍历计划中的场景，依次调用 `start_scene_execution` 或在同一 `execution` 下聚合，各有取舍。V1 可简单设计：  
    - `execution.target_type = PLAN`  
    - `execution_step` 中引入 `scene_id`、`scene_step_id` 以区分归属。

- 执行模式说明：  
  - V1 场景步数建议控制在 50 以内，同步执行即可满足需求。  
  - 预留扩展点：未来可将执行逻辑抽象为可由任务队列（如 Celery）消费的任务，以支持异步和大规模执行。

---

**六、前端设计（React）**

**6.1 前端整体结构**

- 路由结构（建议）：  
  - `/login` 登录页  
  - `/projects` 项目列表  
  - `/projects/:id/dashboard` 项目概览（可后置）  
  - `/projects/:id/apis` 接口列表 + 编辑页  
  - `/projects/:id/cases` 单接口用例列表 + 编辑页  
  - `/projects/:id/scenes` 场景列表 + 场景编排页面  
  - `/projects/:id/plans` 测试计划列表 + 编辑  
  - `/projects/:id/executions` 执行记录列表  
  - `/executions/:id` 执行详情（用例/场景/计划共用页面，按 target_type 渲染）  
  - `/projects/:id/settings/envs` 环境管理  
  - `/projects/:id/settings/variables` 变量管理  

- 布局：  
  - 顶部：系统标题、用户信息、退出登录。  
  - 左侧：项目维度的功能菜单（接口、用例、场景、计划、执行历史、设置）。  
  - 右侧：内容区。

**6.2 关键页面设计与交互要点**

- 接口管理页：  
  - 列表：模块分组、搜索（名称、URL）、方法筛选。  
  - 编辑页：  
    - 基本信息：名称、方法、URL、模块、描述。  
    - 请求模板：Path/Query/Header/Body 的可视化编辑（可以使用表格 + JSON 编辑框）。

- 单接口用例页：  
  - 使用接口模板为基础，允许覆盖部分字段。  
  - 请求区域与响应区域左右或上下布局。  
  - 执行时可选择环境，结果区域展示请求/响应、断言结果。  

- 场景编排页（核心体验）：  
  - 上部：场景基本信息。  
  - 中部：步骤列表（支持拖拽排序），每步显示：顺序、名称、关联接口/用例、是否启用。  
  - 右侧或弹出：当前步骤的详细配置（请求覆盖、断言、变量抽取）。  
  - 提供变量提示（自动列出当前场景已有变量）。  

- 测试计划页：  
  - 列表：计划名称、项目、最近一次执行时间与结果。  
  - 编辑页：  
    - 左侧：可选场景列表。  
    - 右侧：已选场景列表（支持排序）。  

- 执行详情页：  
  - 顶部：执行基本信息（类型、目标、环境、触发人、时间、整体结果）。  
  - 中部：场景/步骤树形结构（或表格），每行显示步骤状态。  
  - 右侧/下方：选中步骤的请求/响应、断言详情。  

**6.3 前端状态管理与与后端交互**

- 建议：  
  - 使用 React Query 或类似库管理 API 数据获取和缓存。  
  - 对于跨页面共享状态（如当前项目、当前用户信息）使用 Context 或 Redux/RTK。  

- 错误处理：  
  - 对后端返回错误进行统一处理，如 Token 失效自动跳转到登录。  
  - 在执行失败时展示具体错误信息与断言差异。

---

**七、接口设计原则与示例**

**7.1 设计原则**

- RESTful 风格，使用资源名 + HTTP 方法表达含义。  
- 使用统一的响应结构，例如：

```json
{
  "code": 0,
  "message": "ok",
  "data": { ... }
}
```

- 错误统一通过非 0 code + message 表达，HTTP 状态码用于区分客户端错误 / 服务端错误。  
- 列表接口支持分页和搜索参数。

**7.2 示例接口**

- 登录：`POST /api/v1/auth/login`  
- 项目：  
  - `GET /api/v1/projects`  
  - `POST /api/v1/projects`  
  - `GET /api/v1/projects/{project_id}`  
  - `PATCH /api/v1/projects/{project_id}`  
  - `DELETE /api/v1/projects/{project_id}`  

- 场景执行：  
  - `POST /api/v1/scenes/{scene_id}/execute`  
    - 请求体：`{ "environment_id": 1 }`  
    - 响应：返回 `execution_id` 和初步结果。  

- 执行详情：  
  - `GET /api/v1/executions/{execution_id}`  
  - `GET /api/v1/executions/{execution_id}/steps`  

（完整 API 清单可在后续详细接口设计文档中补充。）

---

**八、非功能设计**

- 性能：  
  - 同步执行模式下，限制单次场景执行的步骤数量（< 50），避免单次请求过长。  
  - 可配置 HTTP 请求超时（如 5~30 秒），超时需清晰标记。  

- 日志：  
  - 后端使用结构化日志，记录关键操作（登录、创建/删除项目、执行测试等）和错误信息。  
  - 执行引擎对于请求/响应快照写入数据库时注意大小控制（如响应体超过一定长度时截断）。  

- 安全：  
  - 不在日志中打印敏感信息（密码、Token 明文）。  
  - 对外暴露的接口通过 HTTPS 访问。  

- 可扩展性：  
  - 执行引擎抽象成独立模块，未来可替换执行方式（同步 → 异步队列）。  
  - 变量体系（GLOBAL/ENV/SCENE）设计为通用模型，方便添加 DATA 驱动（CASE 级变量）等。  

---

**九、与 PRD V1 的对应关系检查**

- 项目与环境管理：  
  - 后端 `project`、`environment` 模型 + 对应路由；前端项目列表、环境配置页。  

- 接口管理（手工维护）：  
  - `api` + `api_request_template` + 接口列表/编辑页面。  

- 单接口测试用例：  
  - `api_test_case` + `api_test_case_assert` + 用例执行接口 + 用例管理页面。  

- 场景/多接口组合测试（含变量传递与断言）：  
  - `scene`、`scene_step`、`scene_step_extract`、`scene_step_assert` + 执行引擎支持变量流转。  

- 测试计划与执行管理：  
  - `test_plan`、`test_plan_scene`、`execution`、`execution_step` + 计划/执行页面。  

- 执行结果与基础报告查看：  
  - 执行详情接口 + 前端执行详情页；支持复制文本/Markdown。  

- 简单登录与基础角色：  
  - `user` 表、登录接口、JWT 鉴权、role 字段控制基础权限。  
